数据转换规则的清洗选项 PRD（产品需求文档）

1. 背景与目标
- 背景：在数据预处理阶段，针对数值型字段提供常用的分布变换与清洗能力（对数、平方根、Box-Cox、Yeo-Johnson、分位数变换），并支持所选字段的分布预览与参数配置，以便用户在应用规则前直观评估效果。
- 目标：让用户可视化地比较原始分布与转换后分布，合理设置参数并保存规则，确保在后续清洗流程中稳定、可控、可追溯地应用。
- 指标：降低偏态、增加近似正态性；提升数据质量评分；提高用户配置操作的成功率与效率。

2. 名词与约束
- 字段：用户数据集中可选的数值型列。
- 分布预览：缩略图和大图两种视图，展示直方图与正态曲线叠加，并标注统计量（均值、标准差、样本量）。
- 变换方法：log、sqrt、box_cox、yeo_johnson、quantile（含 uniform 与 normal 两种输出分布）。
- 参数：不同方法对应的可选参数，如 λ（lambda）、分位数数目、输出分布等。
- 约束：Box-Cox仅正值；sqrt非负；log默认自然对数，对非正值须先偏移或选择Yeo-Johnson；Yeo-Johnson可处理负值；quantile进行CDF映射。

3. 范围（In-Scope）
- 支持选择多个数值型字段，并行展示分布预览。
- 支持为每条清洗规则配置一种变换方法及其参数。
- 支持预览缩略图、小窗内预览、查看大图对话框。
- 支持方法说明、参数校验与提示文案。
- 支持保存规则并在后续清洗流程中应用。

4. 非目标（Out-of-Scope）
- 不涉及时序重采样、缺失值插补等其他清洗能力的实现细节（它们由独立规则负责）。
- 不实现分布拟合优选算法（如自动选择最佳变换方法）。
- 不提供分布统计的导出与报告生成。

5. 用户故事
- 作为数据分析师，我希望对右偏的温度字段进行变换（如对数或平方根），并在预览中看到直方图更接近对称，以提升建模效果。
- 作为工程人员，我希望在含负值的电压字段中使用Yeo-Johnson，并通过参数λ的自动估计获得稳定的转换效果。
- 作为研究者，我希望通过分位数变换将数据映射到均匀或正态分布，以对比不同输出分布对模型的影响。

6. 交互与UI规范
- 字段选择区：提供可多选的字段清单，仅显示或允许选择数值型字段；非数值型字段灰显或不可选。
- 方法选择与参数区：
  - 方法下拉 Select：log、sqrt、box_cox、yeo_johnson、quantile。
  - 参数输入：
    - log：默认 base=e；提供说明“非正值需偏移或使用Yeo-Johnson”。（可选：base参数与偏移量）
    - sqrt：无额外参数，提示“仅适用于非负值”。
    - box_cox：λ（lambda），默认自动估计；提示“仅适用于正值”。
    - yeo_johnson：λ（lambda），默认自动估计；提示“可处理负值”。
    - quantile：nQuantiles（默认100）、outputDistribution（uniform|normal）。
- 分布预览（缩略图）：
  - 每张卡片内展示字段名、原始分布图，若存在转换结果则在下方展示“转换后”分布图。
  - 直方图叠加正态曲线（以 μ、σ 生成高斯曲线），Y轴为密度；顶部展示 μ、σ、n。
  - 固定高度约160–180px；宽度随卡片自适应。
  - 栅格布局：使用 auto-fit + minmax 以保证每个卡片的最小宽度（建议≥280px），在窄容器下自动减少列数；极窄容器时允许横向滚动，图表保持可读宽度。
- 查看大图：
  - 弹窗包含两幅图并排或栅格布局，支持更宽视图；Y轴、X轴范围统一以便对比。
  - 支持 Brush（可选开启），用于区间放大查看。
- 文案与提示：在方法说明区显示边界与注意事项；当输入不合法时给出错误提示并禁止保存。

7. 数据与算法规范
- 采样与性能：预览构建对每字段进行最多 N=15000 的蓄水池采样（reservoir sampling），以平衡性能与代表性。
- 直方图构建：默认使用 Freedman–Diaconis 规则或固定分箱数（如50），根据数据分布范围与样本量自适应。
- 正态曲线：以 μ（均值）与 σ（标准差）生成高斯概率密度函数并叠加展示。
- 变换实现：
  - log(x)：默认 base=e；若存在非正值，需先偏移或改用Yeo-Johnson；提供风险提示。
  - sqrt(x)：要求 x≥0。
  - Box-Cox：x>0，λ 默认自动（最大似然估计），或用户手动输入。
  - Yeo-Johnson：x∈ℝ，λ 默认自动（最大似然估计），或用户手动输入。
  - Quantile：通过CDF映射到目标分布；uniform 映射到[0,1]，normal 映射到 N(0,1)。
- 统计与域：
  - 统计量显示 μ、σ、n；
  - 比较图的 X 轴范围统一为两者的并集，使原始与转换后可直观对比；
  - Y 轴上限为两者密度最大值的 1.15 倍，以避免截顶。

8. 参数校验与错误处理
- 类型校验：仅允许数值型字段参与预览与变换。
- 值域校验：log/box_cox/sqrt 的输入域限制与提示；非法时禁止保存并给出明确文案。
- λ 校验：若用户输入非数值或超范围，提示并恢复自动估计。
- quantile 校验：分位数数目应在合理范围（如1–1000）。
- 空值与异常：NaN、null、undefined 在预览统计中忽略并计数提示。

9. 性能与技术约束
- 前端渲染：图表组件采用 Recharts；容器小宽度兜底逻辑：当测得宽度过小（阈值约160px）时以数值尺寸渲染并支持横向滚动，确保可读性。
- 栅格布局：分布预览区域使用 repeat(auto-fit,minmax(≥280px,1fr))；卡片内部容器需 w-full、min-w-0，避免在 grid/flex 下被压缩。
- 交互响应：参数变更应在 100ms 内更新预览；大数据集依赖采样保证不卡顿。

10. 权限与安全
- 权限：仅已授权的项目成员可访问并保存清洗规则。
- 安全：不涉及敏感信息；API Key 等敏感配置由系统统一管理。

11. 埋点与指标
- 记录变换方法选择次数、参数调整次数、预览打开次数、规则保存次数。
- 统计用户在不同方法下的成功率与回滚率，为默认参数优化提供依据。

12. 验收标准（可测试）
- 字段选择后，缩略图正确显示原始分布，方法选择与参数调整后显示转换后分布，统计量更新正确。
- log/sqrt/box_cox 的域限制提示明确且阻止非法保存；yeo_johnson/quantile 的参数校验有效。
- 栅格布局在窄容器下自动减少列数，每卡片最小宽度≥设定阈值；极窄容器触发横向滚动但图表可读。
- 查看大图弹窗展示两图并排或栅格，对比范围、密度与曲线一致；可选 Brush 工作正常。
- 性能满足：选中 3–6 个字段且样本量≥10万时，交互仍流畅，预览稳定（依赖采样）。
- 规则保存成功后，可在后续清洗阶段正确应用并可追溯。

13. 里程碑
- M1：交互与预览基础（字段选择、方法选择、缩略图、统计量）。
- M2：方法参数与校验完善（λ自动/手动、quantile参数、提示文案）。
- M3：查看大图、Brush、统一域与密度上限逻辑。
- M4：性能与响应式优化（采样、栅格自适应、小宽度兜底）。
- M5：规则保存与集成到清洗流程，埋点与验收。

14. 风险与依赖
- 风险：极端分布或大量异常值导致统计不稳；过窄布局影响可读性。
- 依赖：图表库（Recharts）、现有数据预览管线（rawPreviewRows）、变换方法库或实现。

15. 待确认问题（需产品/用户决策）
- 是否需要为 log 变换提供“基数选择”和“偏移量”两个参数？默认是否只保留 base=e？
- 直方图分箱是否固定为50，或采用FD规则自适应？是否提供用户可选？
- 缩略图卡片最小宽度阈值是否设为280px，是否需要提升到320px以增强可读性？
- 查看大图是否默认开启 Brush？是否提供导出图像的能力？